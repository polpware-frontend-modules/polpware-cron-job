import { Injectable } from '@angular/core';
import { IntervalEnum } from '@polpware/fe-utilities';
import { parseExpression } from 'cron-parser';
import * as i0 from "@angular/core";
export class CronJobService {
    constructor() { }
    parseCronExpr(source, target) {
        // Above is the UTC representation        
        const a = parseExpression(source);
        // Case 1 (every year)
        if (a.fields.month.length == 1 && a.fields.dayOfMonth.length == 1) {
            target.recurrence = IntervalEnum.Year;
            // utc time
            const today = new Date();
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), a.fields.month[0], parseInt(a.fields.dayOfMonth[0].toString(), 10), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            // Time
            target.dayOfMonth = timeInUtc.getDate();
            target.monthOfYear = timeInUtc.getMonth();
            target.time = timeInUtc;
        }
        else if (a.fields.month.length == 12 &&
            a.fields.dayOfMonth.length == 1 &&
            a.fields.dayOfWeek.length == 8) {
            target.recurrence = IntervalEnum.Month;
            // utc time
            const today = new Date();
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), today.getMonth(), parseInt(a.fields.dayOfMonth[0].toString(), 10), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            // Time
            target.dayOfMonth = timeInUtc.getDate();
            target.time = timeInUtc;
        }
        else if (a.fields.month.length == 12 &&
            a.fields.dayOfMonth.length == 31 &&
            a.fields.dayOfWeek.length == 1) {
            target.recurrence = IntervalEnum.Week;
            // utc time
            const today = new Date();
            const weekOfDay = a.fields.dayOfWeek[0];
            const daysToAdd = weekOfDay - today.getDay();
            today.setDate(today.getDate() + daysToAdd);
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate(), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            // Time
            target.dayOfWeek = timeInUtc.getDay();
            target.time = timeInUtc;
        }
        else if (a.fields.month.length == 12 &&
            a.fields.dayOfMonth.length == 31 &&
            a.fields.dayOfWeek.length == 8) {
            target.recurrence = IntervalEnum.Day;
            // utc time
            const today = new Date();
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate(), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            // Time
            target.time = timeInUtc;
        }
        else {
            target.recurrence = IntervalEnum.Custom;
            // todo:
            // A utc time 
            const today = new Date();
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate(), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            target.time = timeInUtc;
        }
    }
    composeCronExpr(source) {
        // IsRecurrent true
        if (source.recurrence == IntervalEnum.Year) {
            // Convert it into Utc time
            const localTime = new Date(source.time);
            localTime.setDate(source.dayOfMonth);
            localTime.setMonth(source.monthOfYear);
            const min = localTime.getUTCMinutes();
            const hour = localTime.getUTCHours();
            const dayOfMonth = localTime.getUTCDate();
            const monthOfYear = localTime.getUTCMonth();
            // The difference of hours can lead to the change of the other things.
            return `${min} ${hour} ${dayOfMonth} ${monthOfYear} *`;
        }
        else if (source.recurrence == IntervalEnum.Month) {
            // Convert it into Utc time
            const localTime = new Date(source.time);
            localTime.setDate(source.dayOfMonth);
            const min = localTime.getUTCMinutes();
            const hour = localTime.getUTCHours();
            const dayOfMonth = localTime.getUTCDate();
            return `${min} ${hour} ${dayOfMonth} * *`;
        }
        else if (source.recurrence == IntervalEnum.Week) {
            // Convert it into Utc time
            const localTime = new Date(source.time);
            let sourceDayOfWeek = source.dayOfWeek;
            let currentDay = localTime.getDay();
            let distance = sourceDayOfWeek - currentDay;
            localTime.setDate(localTime.getDate() + distance);
            const min = localTime.getUTCMinutes();
            const hour = localTime.getUTCHours();
            const dayOfWeek = localTime.getUTCDay();
            return `${min} ${hour} * * ${dayOfWeek}`;
        }
        else if (source.recurrence == IntervalEnum.Day) {
            const localTime = new Date(source.time);
            const min = localTime.getUTCMinutes();
            const hour = localTime.getUTCHours();
            return `${min} ${hour} * * *`;
        }
        else if (source.recurrence == IntervalEnum.Custom) {
            return source.customExpr;
        }
        return '';
    }
}
CronJobService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.12", ngImport: i0, type: CronJobService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
CronJobService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.3.12", ngImport: i0, type: CronJobService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.12", ngImport: i0, type: CronJobService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvbi1qb2Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3BvbHB3YXJlL2Nyb24tam9iL3NyYy9saWIvY3Jvbi1qb2Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sYUFBYSxDQUFDOztBQU05QyxNQUFNLE9BQU8sY0FBYztJQUV2QixnQkFBZ0IsQ0FBQztJQUVqQixhQUFhLENBQUMsTUFBYyxFQUFFLE1BQXFCO1FBRS9DLDBDQUEwQztRQUMxQyxNQUFNLENBQUMsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFbEMsc0JBQXNCO1FBQ3RCLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO1lBQy9ELE1BQU0sQ0FBQyxVQUFVLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQztZQUN0QyxXQUFXO1lBQ1gsTUFBTSxLQUFLLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUN6QixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFDbkQsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQ2pCLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFDL0MsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUks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TTs0RkFFVCxjQUFjO2tCQUgxQixVQUFVO21CQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEludGVydmFsRW51bSB9IGZyb20gJ0Bwb2xwd2FyZS9mZS11dGlsaXRpZXMnO1xuaW1wb3J0IHsgcGFyc2VFeHByZXNzaW9uIH0gZnJvbSAnY3Jvbi1wYXJzZXInO1xuaW1wb3J0IHsgSVNjaGVkdWxlVGltZSB9IGZyb20gJy4vaW50ZXJmYWNlcyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ3JvbkpvYlNlcnZpY2Uge1xuXG4gICAgY29uc3RydWN0b3IoKSB7IH1cblxuICAgIHBhcnNlQ3JvbkV4cHIoc291cmNlOiBzdHJpbmcsIHRhcmdldDogSVNjaGVkdWxlVGltZSkge1xuXG4gICAgICAgIC8vIEFib3ZlIGlzIHRoZSBVVEMgcmVwcmVzZW50YXRpb24gICAgICAgIFxuICAgICAgICBjb25zdCBhID0gcGFyc2VFeHByZXNzaW9uKHNvdXJjZSk7XG5cbiAgICAgICAgLy8gQ2FzZSAxIChldmVyeSB5ZWFyKVxuICAgICAgICBpZiAoYS5maWVsZHMubW9udGgubGVuZ3RoID09IDEgJiYgYS5maWVsZHMuZGF5T2ZNb250aC5sZW5ndGggPT0gMSkge1xuICAgICAgICAgICAgdGFyZ2V0LnJlY3VycmVuY2UgPSBJbnRlcnZhbEVudW0uWWVhcjtcbiAgICAgICAgICAgIC8vIHV0YyB0aW1lXG4gICAgICAgICAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBjb25zdCB0aW1lSW5VdGMgPSBuZXcgRGF0ZShEYXRlLlVUQyh0b2RheS5nZXRGdWxsWWVhcigpLFxuICAgICAgICAgICAgICAgIGEuZmllbGRzLm1vbnRoWzBdLFxuICAgICAgICAgICAgICAgIHBhcnNlSW50KGEuZmllbGRzLmRheU9mTW9udGhbMF0udG9TdHJpbmcoKSwgMTApLFxuICAgICAgICAgICAgICAgIGEuZmllbGRzLmhvdXJbMF0gfHwgMCxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5taW51dGVbMF0gfHwgMCkpO1xuICAgICAgICAgICAgLy8gVGltZVxuICAgICAgICAgICAgdGFyZ2V0LmRheU9mTW9udGggPSB0aW1lSW5VdGMuZ2V0RGF0ZSgpO1xuICAgICAgICAgICAgdGFyZ2V0Lm1vbnRoT2ZZZWFyID0gdGltZUluVXRjLmdldE1vbnRoKCk7XG4gICAgICAgICAgICB0YXJnZXQudGltZSA9IHRpbWVJblV0YztcbiAgICAgICAgfSBlbHNlIGlmIChhLmZpZWxkcy5tb250aC5sZW5ndGggPT0gMTIgJiZcbiAgICAgICAgICAgIGEuZmllbGRzLmRheU9mTW9udGgubGVuZ3RoID09IDEgJiZcbiAgICAgICAgICAgIGEuZmllbGRzLmRheU9mV2Vlay5sZW5ndGggPT0gOCkge1xuICAgICAgICAgICAgdGFyZ2V0LnJlY3VycmVuY2UgPSBJbnRlcnZhbEVudW0uTW9udGg7XG4gICAgICAgICAgICAvLyB1dGMgdGltZVxuICAgICAgICAgICAgY29uc3QgdG9kYXkgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgY29uc3QgdGltZUluVXRjID0gbmV3IERhdGUoRGF0ZS5VVEModG9kYXkuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgICAgICAgICB0b2RheS5nZXRNb250aCgpLFxuICAgICAgICAgICAgICAgIHBhcnNlSW50KGEuZmllbGRzLmRheU9mTW9udGhbMF0udG9TdHJpbmcoKSwgMTApLFxuICAgICAgICAgICAgICAgIGEuZmllbGRzLmhvdXJbMF0gfHwgMCxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5taW51dGVbMF0gfHwgMCkpO1xuICAgICAgICAgICAgLy8gVGltZVxuICAgICAgICAgICAgdGFyZ2V0LmRheU9mTW9udGggPSB0aW1lSW5VdGMuZ2V0RGF0ZSgpO1xuICAgICAgICAgICAgdGFyZ2V0LnRpbWUgPSB0aW1lSW5VdGM7XG4gICAgICAgIH0gZWxzZSBpZiAoYS5maWVsZHMubW9udGgubGVuZ3RoID09IDEyICYmXG4gICAgICAgICAgICBhLmZpZWxkcy5kYXlPZk1vbnRoLmxlbmd0aCA9PSAzMSAmJlxuICAgICAgICAgICAgYS5maWVsZHMuZGF5T2ZXZWVrLmxlbmd0aCA9PSAxKSB7XG4gICAgICAgICAgICB0YXJnZXQucmVjdXJyZW5jZSA9IEludGVydmFsRW51bS5XZWVrO1xuICAgICAgICAgICAgLy8gdXRjIHRpbWVcbiAgICAgICAgICAgIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgIGNvbnN0IHdlZWtPZkRheSA9IGEuZmllbGRzLmRheU9mV2Vla1swXTtcbiAgICAgICAgICAgIGNvbnN0IGRheXNUb0FkZCA9IHdlZWtPZkRheSAtIHRvZGF5LmdldERheSgpO1xuICAgICAgICAgICAgdG9kYXkuc2V0RGF0ZSh0b2RheS5nZXREYXRlKCkgKyBkYXlzVG9BZGQpO1xuXG4gICAgICAgICAgICBjb25zdCB0aW1lSW5VdGMgPSBuZXcgRGF0ZShEYXRlLlVUQyh0b2RheS5nZXRGdWxsWWVhcigpLFxuICAgICAgICAgICAgICAgIHRvZGF5LmdldE1vbnRoKCksXG4gICAgICAgICAgICAgICAgdG9kYXkuZ2V0RGF0ZSgpLFxuICAgICAgICAgICAgICAgIGEuZmllbGRzLmhvdXJbMF0gfHwgMCxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5taW51dGVbMF0gfHwgMCkpO1xuICAgICAgICAgICAgLy8gVGltZVxuICAgICAgICAgICAgdGFyZ2V0LmRheU9mV2VlayA9IHRpbWVJblV0Yy5nZXREYXkoKTtcbiAgICAgICAgICAgIHRhcmdldC50aW1lID0gdGltZUluVXRjO1xuICAgICAgICB9IGVsc2UgaWYgKGEuZmllbGRzLm1vbnRoLmxlbmd0aCA9PSAxMiAmJlxuICAgICAgICAgICAgYS5maWVsZHMuZGF5T2ZNb250aC5sZW5ndGggPT0gMzEgJiZcbiAgICAgICAgICAgIGEuZmllbGRzLmRheU9mV2Vlay5sZW5ndGggPT0gOCkge1xuICAgICAgICAgICAgdGFyZ2V0LnJlY3VycmVuY2UgPSBJbnRlcnZhbEVudW0uRGF5O1xuICAgICAgICAgICAgLy8gdXRjIHRpbWVcbiAgICAgICAgICAgIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgIGNvbnN0IHRpbWVJblV0YyA9IG5ldyBEYXRlKERhdGUuVVRDKHRvZGF5LmdldEZ1bGxZZWFyKCksXG4gICAgICAgICAgICAgICAgdG9kYXkuZ2V0TW9udGgoKSxcbiAgICAgICAgICAgICAgICB0b2RheS5nZXREYXRlKCksXG4gICAgICAgICAgICAgICAgYS5maWVsZHMuaG91clswXSB8fCAwLFxuICAgICAgICAgICAgICAgIGEuZmllbGRzLm1pbnV0ZVswXSB8fCAwKSk7XG4gICAgICAgICAgICAvLyBUaW1lXG4gICAgICAgICAgICB0YXJnZXQudGltZSA9IHRpbWVJblV0YztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRhcmdldC5yZWN1cnJlbmNlID0gSW50ZXJ2YWxFbnVtLkN1c3RvbTtcbiAgICAgICAgICAgIC8vIHRvZG86XG5cbiAgICAgICAgICAgIC8vIEEgdXRjIHRpbWUgXG4gICAgICAgICAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBjb25zdCB0aW1lSW5VdGMgPSBuZXcgRGF0ZShEYXRlLlVUQyh0b2RheS5nZXRGdWxsWWVhcigpLFxuICAgICAgICAgICAgICAgIHRvZGF5LmdldE1vbnRoKCksXG4gICAgICAgICAgICAgICAgdG9kYXkuZ2V0RGF0ZSgpLFxuICAgICAgICAgICAgICAgIGEuZmllbGRzLmhvdXJbMF0gfHwgMCxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5taW51dGVbMF0gfHwgMCkpO1xuICAgICAgICAgICAgdGFyZ2V0LnRpbWUgPSB0aW1lSW5VdGM7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wb3NlQ3JvbkV4cHIoc291cmNlOiBJU2NoZWR1bGVUaW1lKSB7XG4gICAgICAgIC8vIElzUmVjdXJyZW50IHRydWVcblxuICAgICAgICBpZiAoc291cmNlLnJlY3VycmVuY2UgPT0gSW50ZXJ2YWxFbnVtLlllYXIpIHtcbiAgICAgICAgICAgIC8vIENvbnZlcnQgaXQgaW50byBVdGMgdGltZVxuICAgICAgICAgICAgY29uc3QgbG9jYWxUaW1lID0gbmV3IERhdGUoc291cmNlLnRpbWUpO1xuICAgICAgICAgICAgbG9jYWxUaW1lLnNldERhdGUoc291cmNlLmRheU9mTW9udGgpO1xuICAgICAgICAgICAgbG9jYWxUaW1lLnNldE1vbnRoKHNvdXJjZS5tb250aE9mWWVhcik7XG4gICAgICAgICAgICBjb25zdCBtaW4gPSBsb2NhbFRpbWUuZ2V0VVRDTWludXRlcygpO1xuICAgICAgICAgICAgY29uc3QgaG91ciA9IGxvY2FsVGltZS5nZXRVVENIb3VycygpO1xuICAgICAgICAgICAgY29uc3QgZGF5T2ZNb250aCA9IGxvY2FsVGltZS5nZXRVVENEYXRlKCk7XG4gICAgICAgICAgICBjb25zdCBtb250aE9mWWVhciA9IGxvY2FsVGltZS5nZXRVVENNb250aCgpO1xuICAgICAgICAgICAgLy8gVGhlIGRpZmZlcmVuY2Ugb2YgaG91cnMgY2FuIGxlYWQgdG8gdGhlIGNoYW5nZSBvZiB0aGUgb3RoZXIgdGhpbmdzLlxuICAgICAgICAgICAgcmV0dXJuIGAke21pbn0gJHtob3VyfSAke2RheU9mTW9udGh9ICR7bW9udGhPZlllYXJ9ICpgO1xuICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZS5yZWN1cnJlbmNlID09IEludGVydmFsRW51bS5Nb250aCkge1xuICAgICAgICAgICAgLy8gQ29udmVydCBpdCBpbnRvIFV0YyB0aW1lXG4gICAgICAgICAgICBjb25zdCBsb2NhbFRpbWUgPSBuZXcgRGF0ZShzb3VyY2UudGltZSk7XG4gICAgICAgICAgICBsb2NhbFRpbWUuc2V0RGF0ZShzb3VyY2UuZGF5T2ZNb250aCk7XG4gICAgICAgICAgICBjb25zdCBtaW4gPSBsb2NhbFRpbWUuZ2V0VVRDTWludXRlcygpO1xuICAgICAgICAgICAgY29uc3QgaG91ciA9IGxvY2FsVGltZS5nZXRVVENIb3VycygpO1xuICAgICAgICAgICAgY29uc3QgZGF5T2ZNb250aCA9IGxvY2FsVGltZS5nZXRVVENEYXRlKCk7XG4gICAgICAgICAgICByZXR1cm4gYCR7bWlufSAke2hvdXJ9ICR7ZGF5T2ZNb250aH0gKiAqYDtcbiAgICAgICAgfSBlbHNlIGlmIChzb3VyY2UucmVjdXJyZW5jZSA9PSBJbnRlcnZhbEVudW0uV2Vlaykge1xuICAgICAgICAgICAgLy8gQ29udmVydCBpdCBpbnRvIFV0YyB0aW1lXG4gICAgICAgICAgICBjb25zdCBsb2NhbFRpbWUgPSBuZXcgRGF0ZShzb3VyY2UudGltZSk7XG4gICAgICAgICAgICBsZXQgc291cmNlRGF5T2ZXZWVrID0gc291cmNlLmRheU9mV2VlaztcbiAgICAgICAgICAgIGxldCBjdXJyZW50RGF5ID0gbG9jYWxUaW1lLmdldERheSgpO1xuICAgICAgICAgICAgbGV0IGRpc3RhbmNlID0gc291cmNlRGF5T2ZXZWVrIC0gY3VycmVudERheTtcbiAgICAgICAgICAgIGxvY2FsVGltZS5zZXREYXRlKGxvY2FsVGltZS5nZXREYXRlKCkgKyBkaXN0YW5jZSk7XG4gICAgICAgICAgICBjb25zdCBtaW4gPSBsb2NhbFRpbWUuZ2V0VVRDTWludXRlcygpO1xuICAgICAgICAgICAgY29uc3QgaG91ciA9IGxvY2FsVGltZS5nZXRVVENIb3VycygpO1xuICAgICAgICAgICAgY29uc3QgZGF5T2ZXZWVrID0gbG9jYWxUaW1lLmdldFVUQ0RheSgpO1xuICAgICAgICAgICAgcmV0dXJuIGAke21pbn0gJHtob3VyfSAqICogJHtkYXlPZldlZWt9YDtcbiAgICAgICAgfSBlbHNlIGlmIChzb3VyY2UucmVjdXJyZW5jZSA9PSBJbnRlcnZhbEVudW0uRGF5KSB7XG4gICAgICAgICAgICBjb25zdCBsb2NhbFRpbWUgPSBuZXcgRGF0ZShzb3VyY2UudGltZSk7XG4gICAgICAgICAgICBjb25zdCBtaW4gPSBsb2NhbFRpbWUuZ2V0VVRDTWludXRlcygpO1xuICAgICAgICAgICAgY29uc3QgaG91ciA9IGxvY2FsVGltZS5nZXRVVENIb3VycygpO1xuICAgICAgICAgICAgcmV0dXJuIGAke21pbn0gJHtob3VyfSAqICogKmA7XG4gICAgICAgIH0gZWxzZSBpZiAoc291cmNlLnJlY3VycmVuY2UgPT0gSW50ZXJ2YWxFbnVtLkN1c3RvbSkge1xuICAgICAgICAgICAgcmV0dXJuIHNvdXJjZS5jdXN0b21FeHByO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuICcnO1xuICAgIH1cbn1cbiJdfQ==