import { Injectable } from '@angular/core';
import { IntervalEnum } from '@polpware/fe-utilities';
import { parseExpression } from 'cron-parser';
import moment from 'moment';
import * as i0 from "@angular/core";
export class CronJobService {
    constructor() { }
    parseCronExpr(source, target) {
        // Above is the UTC representation        
        const a = parseExpression(source);
        // Case 1 (every year)
        if (a.fields.month.length == 1 && a.fields.dayOfMonth.length == 1) {
            target.recurrence = IntervalEnum.Year;
            // utc time
            const today = new Date();
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), a.fields.month[0], parseInt(a.fields.dayOfMonth[0].toString(), 10), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            // Time
            target.dayOfMonth = timeInUtc.getDate();
            target.monthOfYear = timeInUtc.getMonth();
            target.time = timeInUtc;
        }
        else if (a.fields.month.length == 12 &&
            a.fields.dayOfMonth.length == 1 &&
            a.fields.dayOfWeek.length == 8) {
            target.recurrence = IntervalEnum.Month;
            // utc time
            const today = new Date();
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), today.getMonth(), parseInt(a.fields.dayOfMonth[0].toString(), 10), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            // Time
            target.dayOfMonth = timeInUtc.getDate();
            target.time = timeInUtc;
        }
        else if (a.fields.month.length == 12 &&
            a.fields.dayOfMonth.length == 31 &&
            a.fields.dayOfWeek.length == 1) {
            target.recurrence = IntervalEnum.Week;
            // utc time
            const today = new Date();
            const weekOfDay = a.fields.dayOfWeek[0];
            const daysToAdd = weekOfDay - today.getDay();
            today.setDate(today.getDate() + daysToAdd);
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate(), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            // Time
            target.dayOfWeek = timeInUtc.getDay();
            target.time = timeInUtc;
        }
        else if (a.fields.month.length == 12 &&
            a.fields.dayOfMonth.length == 31 &&
            a.fields.dayOfWeek.length == 8) {
            target.recurrence = IntervalEnum.Day;
            // utc time
            const today = new Date();
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate(), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            // Time
            target.time = timeInUtc;
        }
        else {
            target.recurrence = IntervalEnum.Custom;
            // todo:
            // A utc time 
            const today = new Date();
            const timeInUtc = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate(), a.fields.hour[0] || 0, a.fields.minute[0] || 0));
            target.time = timeInUtc;
        }
    }
    composeCronExpr(source) {
        // IsRecurrent true
        if (source.recurrence == IntervalEnum.Year) {
            // Convert it into Utc time
            const utc = new Date(source.time);
            utc.setDate(source.dayOfMonth);
            utc.setMonth(source.monthOfYear);
            const timeWrapper = moment(utc);
            const hour = timeWrapper.utc().hour();
            const dayOfMonth = timeWrapper.utc().daysInMonth();
            const monthOfYear = timeWrapper.utc().month();
            // The difference of hours can lead to the change of the other things.
            return `${utc.getMinutes()} ${hour} ${dayOfMonth} ${monthOfYear} *`;
        }
        else if (source.recurrence == IntervalEnum.Month) {
            // Convert it into Utc time
            const utc = new Date(source.time);
            utc.setDate(source.dayOfMonth);
            const timeWrapper = moment(utc);
            const hour = timeWrapper.utc().hour();
            const dayOfMonth = timeWrapper.utc().daysInMonth();
            return `${utc.getMinutes()} ${hour} ${dayOfMonth} * *`;
        }
        else if (source.recurrence == IntervalEnum.Week) {
            // Convert it into Utc time
            const utc = new Date(source.time);
            let sourceDayOfWeek = source.dayOfWeek;
            let currentDay = utc.getDay();
            let distance = sourceDayOfWeek - currentDay;
            utc.setDate(utc.getDate() + distance);
            const timeWrapper = moment(utc);
            const hour = timeWrapper.utc().hour();
            const dayOfWeek = timeWrapper.utc().day();
            return `${utc.getMinutes()} ${hour} * * ${dayOfWeek}`;
        }
        else if (source.recurrence == IntervalEnum.Day) {
            const utc = new Date(source.time);
            const timeWrapper = moment(utc);
            const hour = timeWrapper.utc().hour();
            return `${utc.getMinutes()} ${hour} * * *`;
        }
        else if (source.recurrence == IntervalEnum.Custom) {
            return source.customExpr;
        }
        return '';
    }
}
CronJobService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.12", ngImport: i0, type: CronJobService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
CronJobService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.3.12", ngImport: i0, type: CronJobService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.12", ngImport: i0, type: CronJobService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return []; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvbi1qb2Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3BvbHB3YXJlL2Nyb24tam9iL3NyYy9saWIvY3Jvbi1qb2Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzlDLE9BQU8sTUFBTSxNQUFNLFFBQVEsQ0FBQzs7QUFNNUIsTUFBTSxPQUFPLGNBQWM7SUFFdkIsZ0JBQWdCLENBQUM7SUFFakIsYUFBYSxDQUFDLE1BQWMsRUFBRSxNQUFxQjtRQUUvQywwQ0FBMEM7UUFDMUMsTUFBTSxDQUFDLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWxDLHNCQUFzQjtRQUN0QixJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtZQUMvRCxNQUFNLENBQUMsVUFBVSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUM7WUFDdEMsV0FBVztZQUNYLE1BQU0sS0FBSyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7WUFDekIsTUFBTSxTQUFTLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLEVBQ25ELENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUNqQixRQUFRLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQy9DLENBQUMsQ0FBQyxNQUFN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WUFDdEMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxVQUFVLEVBQUUsSUFBSSxJQUFJLFFBQVEsQ0FBQztTQUM5QzthQUFNLElBQUksTUFBTSxDQUFDLFVBQVUsSUFBSSxZQUFZLENBQUMsTUFBTSxFQUFFO1lBQ2pELE9BQU8sTUFBTSxDQUFDLFVBQVUsQ0FBQztTQUM1QjtRQUVELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQzs7NEdBOUhRLGNBQWM7Z0hBQWQsY0FBYyxjQUZYLE1BQU07NEZBRVQsY0FBYztrQkFIMUIsVUFBVTttQkFBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJbnRlcnZhbEVudW0gfSBmcm9tICdAcG9scHdhcmUvZmUtdXRpbGl0aWVzJztcbmltcG9ydCB7IHBhcnNlRXhwcmVzc2lvbiB9IGZyb20gJ2Nyb24tcGFyc2VyJztcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50JztcbmltcG9ydCB7IElTY2hlZHVsZVRpbWUgfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIENyb25Kb2JTZXJ2aWNlIHtcblxuICAgIGNvbnN0cnVjdG9yKCkgeyB9XG5cbiAgICBwYXJzZUNyb25FeHByKHNvdXJjZTogc3RyaW5nLCB0YXJnZXQ6IElTY2hlZHVsZVRpbWUpIHtcblxuICAgICAgICAvLyBBYm92ZSBpcyB0aGUgVVRDIHJlcHJlc2VudGF0aW9uICAgICAgICBcbiAgICAgICAgY29uc3QgYSA9IHBhcnNlRXhwcmVzc2lvbihzb3VyY2UpO1xuXG4gICAgICAgIC8vIENhc2UgMSAoZXZlcnkgeWVhcilcbiAgICAgICAgaWYgKGEuZmllbGRzLm1vbnRoLmxlbmd0aCA9PSAxICYmIGEuZmllbGRzLmRheU9mTW9udGgubGVuZ3RoID09IDEpIHtcbiAgICAgICAgICAgIHRhcmdldC5yZWN1cnJlbmNlID0gSW50ZXJ2YWxFbnVtLlllYXI7XG4gICAgICAgICAgICAvLyB1dGMgdGltZVxuICAgICAgICAgICAgY29uc3QgdG9kYXkgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgY29uc3QgdGltZUluVXRjID0gbmV3IERhdGUoRGF0ZS5VVEModG9kYXkuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5tb250aFswXSxcbiAgICAgICAgICAgICAgICBwYXJzZUludChhLmZpZWxkcy5kYXlPZk1vbnRoWzBdLnRvU3RyaW5nKCksIDEwKSxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5ob3VyWzBdIHx8IDAsXG4gICAgICAgICAgICAgICAgYS5maWVsZHMubWludXRlWzBdIHx8IDApKTtcbiAgICAgICAgICAgIC8vIFRpbWVcbiAgICAgICAgICAgIHRhcmdldC5kYXlPZk1vbnRoID0gdGltZUluVXRjLmdldERhdGUoKTtcbiAgICAgICAgICAgIHRhcmdldC5tb250aE9mWWVhciA9IHRpbWVJblV0Yy5nZXRNb250aCgpO1xuICAgICAgICAgICAgdGFyZ2V0LnRpbWUgPSB0aW1lSW5VdGM7XG4gICAgICAgIH0gZWxzZSBpZiAoYS5maWVsZHMubW9udGgubGVuZ3RoID09IDEyICYmXG4gICAgICAgICAgICBhLmZpZWxkcy5kYXlPZk1vbnRoLmxlbmd0aCA9PSAxICYmXG4gICAgICAgICAgICBhLmZpZWxkcy5kYXlPZldlZWsubGVuZ3RoID09IDgpIHtcbiAgICAgICAgICAgIHRhcmdldC5yZWN1cnJlbmNlID0gSW50ZXJ2YWxFbnVtLk1vbnRoO1xuICAgICAgICAgICAgLy8gdXRjIHRpbWVcbiAgICAgICAgICAgIGNvbnN0IHRvZGF5ID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgIGNvbnN0IHRpbWVJblV0YyA9IG5ldyBEYXRlKERhdGUuVVRDKHRvZGF5LmdldEZ1bGxZZWFyKCksXG4gICAgICAgICAgICAgICAgdG9kYXkuZ2V0TW9udGgoKSxcbiAgICAgICAgICAgICAgICBwYXJzZUludChhLmZpZWxkcy5kYXlPZk1vbnRoWzBdLnRvU3RyaW5nKCksIDEwKSxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5ob3VyWzBdIHx8IDAsXG4gICAgICAgICAgICAgICAgYS5maWVsZHMubWludXRlWzBdIHx8IDApKTtcbiAgICAgICAgICAgIC8vIFRpbWVcbiAgICAgICAgICAgIHRhcmdldC5kYXlPZk1vbnRoID0gdGltZUluVXRjLmdldERhdGUoKTtcbiAgICAgICAgICAgIHRhcmdldC50aW1lID0gdGltZUluVXRjO1xuICAgICAgICB9IGVsc2UgaWYgKGEuZmllbGRzLm1vbnRoLmxlbmd0aCA9PSAxMiAmJlxuICAgICAgICAgICAgYS5maWVsZHMuZGF5T2ZNb250aC5sZW5ndGggPT0gMzEgJiZcbiAgICAgICAgICAgIGEuZmllbGRzLmRheU9mV2Vlay5sZW5ndGggPT0gMSkge1xuICAgICAgICAgICAgdGFyZ2V0LnJlY3VycmVuY2UgPSBJbnRlcnZhbEVudW0uV2VlaztcbiAgICAgICAgICAgIC8vIHV0YyB0aW1lXG4gICAgICAgICAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBjb25zdCB3ZWVrT2ZEYXkgPSBhLmZpZWxkcy5kYXlPZldlZWtbMF07XG4gICAgICAgICAgICBjb25zdCBkYXlzVG9BZGQgPSB3ZWVrT2ZEYXkgLSB0b2RheS5nZXREYXkoKTtcbiAgICAgICAgICAgIHRvZGF5LnNldERhdGUodG9kYXkuZ2V0RGF0ZSgpICsgZGF5c1RvQWRkKTtcblxuICAgICAgICAgICAgY29uc3QgdGltZUluVXRjID0gbmV3IERhdGUoRGF0ZS5VVEModG9kYXkuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgICAgICAgICB0b2RheS5nZXRNb250aCgpLFxuICAgICAgICAgICAgICAgIHRvZGF5LmdldERhdGUoKSxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5ob3VyWzBdIHx8IDAsXG4gICAgICAgICAgICAgICAgYS5maWVsZHMubWludXRlWzBdIHx8IDApKTtcbiAgICAgICAgICAgIC8vIFRpbWVcbiAgICAgICAgICAgIHRhcmdldC5kYXlPZldlZWsgPSB0aW1lSW5VdGMuZ2V0RGF5KCk7XG4gICAgICAgICAgICB0YXJnZXQudGltZSA9IHRpbWVJblV0YztcbiAgICAgICAgfSBlbHNlIGlmIChhLmZpZWxkcy5tb250aC5sZW5ndGggPT0gMTIgJiZcbiAgICAgICAgICAgIGEuZmllbGRzLmRheU9mTW9udGgubGVuZ3RoID09IDMxICYmXG4gICAgICAgICAgICBhLmZpZWxkcy5kYXlPZldlZWsubGVuZ3RoID09IDgpIHtcbiAgICAgICAgICAgIHRhcmdldC5yZWN1cnJlbmNlID0gSW50ZXJ2YWxFbnVtLkRheTtcbiAgICAgICAgICAgIC8vIHV0YyB0aW1lXG4gICAgICAgICAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBjb25zdCB0aW1lSW5VdGMgPSBuZXcgRGF0ZShEYXRlLlVUQyh0b2RheS5nZXRGdWxsWWVhcigpLFxuICAgICAgICAgICAgICAgIHRvZGF5LmdldE1vbnRoKCksXG4gICAgICAgICAgICAgICAgdG9kYXkuZ2V0RGF0ZSgpLFxuICAgICAgICAgICAgICAgIGEuZmllbGRzLmhvdXJbMF0gfHwgMCxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5taW51dGVbMF0gfHwgMCkpO1xuICAgICAgICAgICAgLy8gVGltZVxuICAgICAgICAgICAgdGFyZ2V0LnRpbWUgPSB0aW1lSW5VdGM7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0YXJnZXQucmVjdXJyZW5jZSA9IEludGVydmFsRW51bS5DdXN0b207XG4gICAgICAgICAgICAvLyB0b2RvOlxuXG4gICAgICAgICAgICAvLyBBIHV0YyB0aW1lIFxuICAgICAgICAgICAgY29uc3QgdG9kYXkgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgY29uc3QgdGltZUluVXRjID0gbmV3IERhdGUoRGF0ZS5VVEModG9kYXkuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgICAgICAgICB0b2RheS5nZXRNb250aCgpLFxuICAgICAgICAgICAgICAgIHRvZGF5LmdldERhdGUoKSxcbiAgICAgICAgICAgICAgICBhLmZpZWxkcy5ob3VyWzBdIHx8IDAsXG4gICAgICAgICAgICAgICAgYS5maWVsZHMubWludXRlWzBdIHx8IDApKTtcbiAgICAgICAgICAgIHRhcmdldC50aW1lID0gdGltZUluVXRjO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29tcG9zZUNyb25FeHByKHNvdXJjZTogSVNjaGVkdWxlVGltZSkge1xuICAgICAgICAvLyBJc1JlY3VycmVudCB0cnVlXG5cbiAgICAgICAgaWYgKHNvdXJjZS5yZWN1cnJlbmNlID09IEludGVydmFsRW51bS5ZZWFyKSB7XG4gICAgICAgICAgICAvLyBDb252ZXJ0IGl0IGludG8gVXRjIHRpbWVcbiAgICAgICAgICAgIGNvbnN0IHV0YyA9IG5ldyBEYXRlKHNvdXJjZS50aW1lKTtcbiAgICAgICAgICAgIHV0Yy5zZXREYXRlKHNvdXJjZS5kYXlPZk1vbnRoKTtcbiAgICAgICAgICAgIHV0Yy5zZXRNb250aChzb3VyY2UubW9udGhPZlllYXIpO1xuICAgICAgICAgICAgY29uc3QgdGltZVdyYXBwZXIgPSBtb21lbnQodXRjKTtcbiAgICAgICAgICAgIGNvbnN0IGhvdXIgPSB0aW1lV3JhcHBlci51dGMoKS5ob3VyKCk7XG4gICAgICAgICAgICBjb25zdCBkYXlPZk1vbnRoID0gdGltZVdyYXBwZXIudXRjKCkuZGF5c0luTW9udGgoKTtcbiAgICAgICAgICAgIGNvbnN0IG1vbnRoT2ZZZWFyID0gdGltZVdyYXBwZXIudXRjKCkubW9udGgoKTtcbiAgICAgICAgICAgIC8vIFRoZSBkaWZmZXJlbmNlIG9mIGhvdXJzIGNhbiBsZWFkIHRvIHRoZSBjaGFuZ2Ugb2YgdGhlIG90aGVyIHRoaW5ncy5cbiAgICAgICAgICAgIHJldHVybiBgJHt1dGMuZ2V0TWludXRlcygpfSAke2hvdXJ9ICR7ZGF5T2ZNb250aH0gJHttb250aE9mWWVhcn0gKmA7XG4gICAgICAgIH0gZWxzZSBpZiAoc291cmNlLnJlY3VycmVuY2UgPT0gSW50ZXJ2YWxFbnVtLk1vbnRoKSB7XG4gICAgICAgICAgICAvLyBDb252ZXJ0IGl0IGludG8gVXRjIHRpbWVcbiAgICAgICAgICAgIGNvbnN0IHV0YyA9IG5ldyBEYXRlKHNvdXJjZS50aW1lKTtcbiAgICAgICAgICAgIHV0Yy5zZXREYXRlKHNvdXJjZS5kYXlPZk1vbnRoKTtcbiAgICAgICAgICAgIGNvbnN0IHRpbWVXcmFwcGVyID0gbW9tZW50KHV0Yyk7XG4gICAgICAgICAgICBjb25zdCBob3VyID0gdGltZVdyYXBwZXIudXRjKCkuaG91cigpO1xuICAgICAgICAgICAgY29uc3QgZGF5T2ZNb250aCA9IHRpbWVXcmFwcGVyLnV0YygpLmRheXNJbk1vbnRoKCk7XG4gICAgICAgICAgICByZXR1cm4gYCR7dXRjLmdldE1pbnV0ZXMoKX0gJHtob3VyfSAke2RheU9mTW9udGh9ICogKmA7XG4gICAgICAgIH0gZWxzZSBpZiAoc291cmNlLnJlY3VycmVuY2UgPT0gSW50ZXJ2YWxFbnVtLldlZWspIHtcbiAgICAgICAgICAgIC8vIENvbnZlcnQgaXQgaW50byBVdGMgdGltZVxuICAgICAgICAgICAgY29uc3QgdXRjID0gbmV3IERhdGUoc291cmNlLnRpbWUpO1xuICAgICAgICAgICAgbGV0IHNvdXJjZURheU9mV2VlayA9IHNvdXJjZS5kYXlPZldlZWs7XG4gICAgICAgICAgICBsZXQgY3VycmVudERheSA9IHV0Yy5nZXREYXkoKTtcbiAgICAgICAgICAgIGxldCBkaXN0YW5jZSA9IHNvdXJjZURheU9mV2VlayAtIGN1cnJlbnREYXk7XG4gICAgICAgICAgICB1dGMuc2V0RGF0ZSh1dGMuZ2V0RGF0ZSgpICsgZGlzdGFuY2UpO1xuICAgICAgICAgICAgY29uc3QgdGltZVdyYXBwZXIgPSBtb21lbnQodXRjKTtcbiAgICAgICAgICAgIGNvbnN0IGhvdXIgPSB0aW1lV3JhcHBlci51dGMoKS5ob3VyKCk7XG4gICAgICAgICAgICBjb25zdCBkYXlPZldlZWsgPSB0aW1lV3JhcHBlci51dGMoKS5kYXkoKTtcbiAgICAgICAgICAgIHJldHVybiBgJHt1dGMuZ2V0TWludXRlcygpfSAke2hvdXJ9ICogKiAke2RheU9mV2Vla31gO1xuICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZS5yZWN1cnJlbmNlID09IEludGVydmFsRW51bS5EYXkpIHtcbiAgICAgICAgICAgIGNvbnN0IHV0YyA9IG5ldyBEYXRlKHNvdXJjZS50aW1lKTtcbiAgICAgICAgICAgIGNvbnN0IHRpbWVXcmFwcGVyID0gbW9tZW50KHV0Yyk7XG4gICAgICAgICAgICBjb25zdCBob3VyID0gdGltZVdyYXBwZXIudXRjKCkuaG91cigpO1xuICAgICAgICAgICAgcmV0dXJuIGAke3V0Yy5nZXRNaW51dGVzKCl9ICR7aG91cn0gKiAqICpgO1xuICAgICAgICB9IGVsc2UgaWYgKHNvdXJjZS5yZWN1cnJlbmNlID09IEludGVydmFsRW51bS5DdXN0b20pIHtcbiAgICAgICAgICAgIHJldHVybiBzb3VyY2UuY3VzdG9tRXhwcjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiAnJztcbiAgICB9XG59XG4iXX0=